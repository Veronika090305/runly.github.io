<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RUNLI ‚Äî –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>

  <style>
    :root{
      --bg:#faf9f7;
      --card:#ffffff;
      --accent:#2b8a7a;
      --muted:#6b7280;
      --radius:12px;
      --shadow: 0 6px 18px rgba(20,20,30,0.06);
      font-family: Inter, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg,#fbfbfb, #f1f5f4); color:#0f172a; padding:24px;}
    .wrap{width:100%; max-width:920px; display:grid; grid-template-columns:1fr 420px; gap:28px;}
    .hero{background:transparent; padding:28px;}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;}
    h1{margin:0 0 12px 0; font-size:20px;}
    p.lead{color:var(--muted); margin-top:8px}
    .tabs{display:flex; gap:8px; margin-bottom:16px}
    .tab{flex:1; text-align:center; padding:10px 12px; border-radius:10px; cursor:pointer; background:#f4f6f6; color:var(--muted); user-select:none;}
    .tab.active{background:linear-gradient(90deg,var(--accent), #2fada0); color:white; font-weight:600}
    form{display:grid; gap:10px;}
    input[type="email"], input[type="password"], select, textarea{width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e7ea; font-size:14px;}
    button{background:var(--accent); color:white; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
    .small{font-size:13px; color:var(--muted)}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px}
    .row .col{flex:1}
    .notice{padding:10px;border-radius:8px;background:#fff7ed;color:#7a4a00;font-size:14px;margin-top:8px}
    .success{background:#ecfdf5;color:#064e3b}
    .link{color:var(--accent); cursor:pointer; text-decoration:underline; font-weight:600; background:none; border:0; padding:0;}
    @media(max-width:900px){ .wrap{grid-template-columns:1fr; padding:0} }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="hero">
      <div class="card">
        <h1>RUNLI ‚Äî –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <p class="lead">–°–æ–∑–¥–∞–π –∞–∫–∫–∞—É–Ω—Ç, —Å–æ—Ö—Ä–∞–Ω—è–π –ø–æ–¥–±–æ—Ä–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ e-mail —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.</p>
        <hr style="margin:16px 0;">
        <p class="small">–ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å:</p>
        <ul class="small">
          <li>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</li>
          <li>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ e-mail</li>
          <li>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –ø–æ e-mail</li>
        </ul>
        <p style="margin-top:12px" class="small muted">–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å SMTP –≤ Supabase (Authentication ‚Üí Emails ‚Üí SMTP Settings) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å.</p>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="tabs">
          <div id="tab-signin" class="tab active">–í—Ö–æ–¥</div>
          <div id="tab-signup" class="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>

        <!-- –í—Ö–æ–¥ -->
        <div id="panel-signin">
          <form id="signin-form">
            <input type="email" id="signin-email" placeholder="Email" required autocomplete="email">
            <input type="password" id="signin-password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="current-password">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button id="toSignup" class="link">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
              <div class="small"><button id="toReset" class="link">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button></div>
            </div>
            <button type="submit">–í–æ–π—Ç–∏</button>
          </form>
          <div id="signin-msg" class="notice" style="display:none"></div>
        </div>

        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div id="panel-signup" style="display:none">
          <form id="signup-form">
            <input type="email" id="signup-email" placeholder="Email" required autocomplete="email">
            <input type="password" id="signup-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" required autocomplete="new-password">
            <div class="row">
              <div class="col">
                <label class="small">–ü–æ–ª</label>
                <select id="signup-gender">
                  <option value="">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
                  <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                  <option value="other">–î—Ä—É–≥–æ–µ</option>
                  <option value="no_answer">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                </select>
              </div>
              <div class="col">
                <label class="small">–í–æ–∑—Ä–∞—Å—Ç</label>
                <select id="signup-age">
                  <option value="">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="<18">–ú–ª–∞–¥—à–µ 18</option>
                  <option value="18-25">18‚Äì25</option>
                  <option value="26-40">26‚Äì40</option>
                  <option value="41-60">41‚Äì60</option>
                  <option value=">60">–ë–æ–ª—å—à–µ 60</option>
                </select>
              </div>
            </div>

            <div style="font-size:12px;color:var(--muted); margin-top:8px">–ù–∞–∂–∏–º–∞—è ¬´–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–µ—Ä–≤–∏—Å–∞.</div>
            <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </form>
          <div id="signup-msg" class="notice" style="display:none"></div>
        </div>

        <!-- –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è -->
        <div id="panel-reset" style="display:none; margin-top:8px">
          <form id="reset-form">
            <input type="email" id="reset-email" placeholder="–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Å–±—Ä–æ—Å–∞" required>
            <div class="small muted" style="margin-bottom:8px">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å.</div>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è —Å–±—Ä–æ—Å–∞</button>
          </form>
          <div id="reset-msg" class="notice" style="display:none"></div>
        </div>

      </div>

      <div style="margin-top:12px" class="card">
        <div id="profile-block" style="display:none">
          <div><strong id="profile-email"></strong></div>
          <div class="small muted" id="profile-info"></div>
          <div style="margin-top:10px">
            <button id="btn-logout" style="background:#f43f5e">–í—ã–π—Ç–∏</button>
            <button id="btn-dashboard" style="margin-left:8px;background:#111827">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>
        </div>
        <div id="not-signed" style="display:block" class="small muted">–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</div>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
  // ============ –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ò –ö–õ–Æ–ß–ò =============
  const SUPABASE_URL = 'https://lyqedngejapolcffscyk.supabase.co'; // <- —Ç–≤–æ–π Project URL
  const SUPABASE_ANON_KEY = '–í–ê–®_ANON_KEY_–¢–£–¢';                 // <- anon public key
  // =================================================
  const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---- UI helpers (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω—ã –ø–µ—Ä–≤—ã–º–∏) ----
  const $ = id => document.getElementById(id);
  const show = (id) => { document.querySelectorAll('[id^="panel-"]').forEach(n=>n.style.display='none'); document.getElementById(id).style.display='block'; }
  function setMsg(id, text, ok=false) {
    const el = $(id); if(!el) return;
    el.style.display = 'block'; el.textContent = text;
    el.className = 'notice' + (ok ? ' success' : '');
  }
  const hideMsg = id => { const el=$(id); if(el) el.style.display='none'; }

  // ---- Tabs handlers (–æ–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ) ----
  const tabSignin = $('tab-signin'), tabSignup = $('tab-signup');

  tabSignin.onclick = ()=>{ tabSignin.classList.add('active'); tabSignup.classList.remove('active'); show('panel-signin'); $('not-signed').style.display='block'; $('profile-block').style.display='none'; };
  tabSignup.onclick = ()=>{ tabSignup.classList.add('active'); tabSignin.classList.remove('active'); show('panel-signup'); $('not-signed').style.display='block'; $('profile-block').style.display='none'; };

  // quick links
  $('toSignup').onclick = ()=>{ tabSignup.click(); };
  $('toReset').onclick = ()=>{ show('panel-reset'); tabSignin.classList.remove('active'); tabSignup.classList.remove('active'); };

  // –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –≤—Ö–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  tabSignin.click();

  // ---- Sign up ----
  $('signup-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    hideMsg('signup-msg');
    const email = $('signup-email').value.trim();
    const password = $('signup-password').value;
    const gender = $('signup-gender').value || null;
    const age_group = $('signup-age').value || null;

    if(password.length < 6){ setMsg('signup-msg','–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }

    try{
      // redirectTo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç current origin ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ runli.ru –∏ –Ω–∞ github pages
      const redirect = window.location.origin + '/auth.html?confirmed=1';
      const { data, error } = await supabase.auth.signUp(
        { email, password },
        { redirectTo: redirect }
      );
      if(error) throw error;

      // –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (upsert)
      const userResult = await supabase.auth.getUser();
      const user = (data && data.user) || (userResult && userResult.data && userResult.data.user) || null;
      if(user){
        await supabase.from('profiles').upsert({
          user_id: user.id,
          gender,
          age_group,
          updated_at: new Date().toISOString()
        }, { onConflict: ['user_id'] });
      }

      setMsg('signup-msg','–ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É ‚Äî –≤—ã—Å–ª–∞–Ω–æ –ø–∏—Å—å–º–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', true);
      $('signup-form').reset();
    }catch(err){
      setMsg('signup-msg','–û—à–∏–±–∫–∞: ' + (err.message || JSON.stringify(err)));
    }
  });

  // ---- Sign in ----
  $('signin-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    hideMsg('signin-msg');
    const email = $('signin-email').value.trim();
    const password = $('signin-password').value;

    try{
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;

      setMsg('signin-msg','–£—Å–ø–µ—à–Ω–æ. –°–µ–π—á–∞—Å –≤—ã –±—É–¥–µ—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.', true);
      $('signin-form').reset();
      await updateUIForUser();
    }catch(err){
      setMsg('signin-msg','–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message || JSON.stringify(err)));
    }
  });

  // ---- Reset password ----
  $('reset-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    hideMsg('reset-msg');
    const email = $('reset-email').value.trim();
    try{
      const redirect = window.location.origin + '/reset-password.html';
      const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: redirect
      });
      if(error) throw error;
      setMsg('reset-msg','–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É ‚Äî —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.', true);
      $('reset-form').reset();
    }catch(err){
      setMsg('reset-msg','–û—à–∏–±–∫–∞: ' + (err.message || JSON.stringify(err)));
    }
  });

  // ---- Logout ----
  $('btn-logout').addEventListener('click', async ()=>{
    await supabase.auth.signOut();
    setMsg('signin-msg','–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', true);
    await updateUIForUser();
  });

  // ---- Dashboard / profile button ----
  $('btn-dashboard').addEventListener('click', ()=>{
    window.location.href = '/profile.html';
  });

  // ---- Keep UI in sync with auth state ----
  async function updateUIForUser(){
    const { data: userData } = await supabase.auth.getUser();
    const user = userData && userData.user;
    if(user){
      $('not-signed').style.display='none';
      $('profile-block').style.display='block';
      $('profile-email').textContent = user.email || '(email –Ω–µ —É–∫–∞–∑–∞–Ω)';
      // –ü–æ–ª—É—á–∏–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
      const { data: profile, error } = await supabase.from('profiles').select('*').eq('user_id', user.id).single();
      if(profile && !error){
        $('profile-info').textContent = (profile.gender?('–ü–æ–ª: '+profile.gender+'; '):'') + (profile.age_group?('–í–æ–∑—Ä–∞—Å—Ç: '+profile.age_group):'');
      } else {
        $('profile-info').textContent = '–ü—Ä–æ—Ñ–∏–ª—è –ø–æ–∫–∞ –Ω–µ—Ç';
      }
    } else {
      $('not-signed').style.display='block';
      $('profile-block').style.display='none';
    }
  }

  // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
  supabase.auth.onAuthStateChange((event, session) => {
    updateUIForUser();
  });

  // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  (async ()=>{ await updateUIForUser(); })();

  // ---- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à—ë–ª –æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ—á—Ç—ã ----
  (function showConfirmedNotice(){
    try{
      // 1) ?confirmed=1 (–º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ redirectTo)
      const params = new URLSearchParams(window.location.search);
      if(params.get('confirmed') === '1'){
        setMsg('signin-msg','üéâ –°–ø–∞—Å–∏–±–æ ‚Äî –≤–∞—à–∞ –ø–æ—á—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ RUNLI!', true);
        tabSignin.click();
        // —É–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
        const clean = location.origin + location.pathname;
        window.history.replaceState({}, document.title, clean);
        return;
      }

      // 2) Supabase –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Ö–µ—à —Å type=signup (e.g. #type=signup...)
      const hash = new URLSearchParams(window.location.hash.replace('#','?'));
      if(hash.get('type') === 'signup'){
        setMsg('signin-msg','üéâ –°–ø–∞—Å–∏–±–æ ‚Äî –≤–∞—à–∞ –ø–æ—á—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ RUNLI!', true);
        tabSignin.click();
        window.history.replaceState({}, document.title, location.pathname);
        return;
      }
    }catch(e){
      // silently ignore
      console.log('confirm-check error', e);
    }
  })();

  </script>
</body>
</html>
