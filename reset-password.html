<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Сброс пароля — RUNLI</title>
</head>
<body>
  <h2>Сброс пароля</h2>
  <p id="info">Подождите — проверяем ссылку...</p>

  <div id="form" style="display:none">
    <label>Новый пароль:<br><input id="newpwd" type="password"></label><br><br>
    <button id="setpwd">Установить новый пароль</button>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Вставь сюда свой SUPABASE_URL и ANON_KEY
    const SUPABASE_URL = 'https://lyqedngejapolcffscyk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cWVkbmdlamFwb2xjZmZzY3lrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzYxOTAsImV4cCI6MjA3ODU1MjE5MH0.xdRoqew8xSAmDbDtryMQBmu7vj9FBj_AQDD5cCJl-_g';
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.hash.replace('#','?')); // supabase может отдавать токен в хэше
    const access_token = params.get('access_token') || new URLSearchParams(window.location.search).get('access_token');

    const info = document.getElementById('info');
    const form = document.getElementById('form');
    const newpwd = document.getElementById('newpwd');
    const btn = document.getElementById('setpwd');

    if(!access_token){
      info.textContent = 'Токен для сброса пароля не найден в URL. Возможно ссылка некорректна.';
    } else {
      info.textContent = 'Токен найден. Введите новый пароль.';
      form.style.display = 'block';
    }

    btn.onclick = async () => {
      const pwd = newpwd.value;
      if(!pwd || pwd.length < 6){ alert('Пароль минимум 6 символов'); return; }
      try{
        // Устанавливаем сессию по токену и меняем пароль
        await supabase.auth.setSession({ access_token });
        const { error } = await supabase.auth.updateUser({ password: pwd });
        if(error) throw error;
        alert('Пароль установлен. Теперь можно войти.');
        window.location.href = '/auth.html';
      } catch(e){
        alert('Ошибка: ' + (e.message || JSON.stringify(e)));
      }
    };
  </script>
</body>
</html>
